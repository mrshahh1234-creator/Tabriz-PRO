<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TABRIZ | Mustafayev Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --gold: #C5A059;
            --bg: #0D0F14;
            --glass: rgba(25, 28, 35, 0.85);
            --border: rgba(197, 160, 89, 0.2);
            --accent: #00F2FF;
        }

        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; transition: 0.3s ease; }
        body { margin: 0; background: var(--bg); color: white; overflow-x: hidden; }

        /* Background Aura */
        body::before {
            content: ""; position: fixed; width: 100vw; height: 100vh;
            background: radial-gradient(circle at 10% 20%, rgba(197, 160, 89, 0.05) 0%, transparent 50%),
                        radial-gradient(circle at 90% 80%, rgba(0, 242, 255, 0.03) 0%, transparent 50%);
            z-index: -1;
        }

        .screen { display: none; padding: 40px; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.5s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* UI Elements */
        .glass-card {
            background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--border);
            border-radius: 24px; padding: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .btn {
            background: var(--gold); color: black; border: none; padding: 15px 30px;
            border-radius: 12px; font-weight: 800; cursor: pointer; text-transform: uppercase;
            letter-spacing: 1px; width: 100%; margin-top: 15px;
        }
        .btn:hover { transform: scale(1.02); box-shadow: 0 0 20px rgba(197, 160, 89, 0.4); }
        .btn-outline { background: transparent; border: 1px solid var(--gold); color: var(--gold); }

        input, select {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border);
            padding: 15px; border-radius: 12px; color: white; margin-top: 8px; font-size: 16px;
        }

        /* Sidebar & Navigation */
        nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .nav-brand { font-weight: 800; color: var(--gold); font-size: 24px; letter-spacing: 2px; }

        /* Custom Table */
        .parts-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        .parts-table th { color: var(--gold); text-align: left; padding: 10px; font-size: 12px; }
        .parts-table td { background: rgba(255,255,255,0.03); padding: 15px; border-top: 1px solid var(--border); }

        /* Watermark */
        .watermark { position: fixed; bottom: 20px; right: 20px; color: var(--gold); opacity: 0.3; font-weight: 800; font-size: 14px; letter-spacing: 3px; }

        /* Nesting Visualizer */
        canvas { background: white; border-radius: 16px; width: 100%; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="watermark">MUSTAFAYEV ACADEMY</div>

    <div id="scr-auth" class="screen active">
        <div style="height: 80vh; display: flex; align-items: center; justify-content: center;">
            <div class="glass-card" style="width: 400px; text-align: center;">
                <div class="nav-brand" style="margin-bottom: 10px;">TABRIZ GROUP</div>
                <p style="color: #888; font-size: 14px;">B2B –ò—à–ª–∞–± —á–∏“õ–∞—Ä–∏—à –ø–æ—Ä—Ç–∞–ª–∏</p>
                <input type="tel" id="auth-phone" placeholder="+998 90 123 45 67">
                <button class="btn" onclick="showScreen('dashboard')">–ö–∏—Ä–∏—à</button>
            </div>
        </div>
    </div>

    <div id="scr-dashboard" class="screen">
        <nav>
            <div class="nav-brand">TABRIZ</div>
            <div style="display: flex; gap: 15px;">
                <button class="btn-outline" style="padding: 10px 20px; border-radius: 8px; cursor: pointer;" onclick="showScreen('account')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
                <button class="btn-outline" style="padding: 10px 20px; border-radius: 8px; cursor: pointer;" onclick="showScreen('help')">‚ùì –Å—Ä–¥–∞–º</button>
            </div>
        </nav>

        <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 30px;">
            <div>
                <div class="glass-card">
                    <h2>–Ø–Ω–≥–∏ –ë—É—é—Ä—Ç–º–∞</h2>
                    <p style="color:#888;">–†–∞—Å–∫—Ä–æ–π “≥–∏—Å–æ–±–ª–∞—à –≤–∞ —Ü–µ—Ö–≥–∞ —é–±–æ—Ä–∏—à</p>
                    <button class="btn" onclick="showScreen('new-order')">‚ûï “ö—û—à–∏—à</button>
                </div>
            </div>
            <div class="glass-card">
                <h3>–°—û–Ω–≥–≥–∏ –∑–∞–∫–∞–∑–∏–ª–∞—Ä</h3>
                <div id="history-list" style="color:#aaa; font-size: 14px;">–ë—É—é—Ä—Ç–º–∞–ª–∞—Ä –º–∞–≤–∂—É–¥ —ç–º–∞—Å.</div>
            </div>
        </div>
    </div>

    <div id="scr-account" class="screen">
        <div class="glass-card" style="max-width: 600px; margin: 0 auto;">
            <h2>–ê–∫–∫–∞—É–Ω—Ç –°–æ–∑–ª–∞–º–∞–ª–∞—Ä–∏</h2>
            <label>–ò—Å–º:</label>
            <input type="text" id="acc-name" value="–ú–µ–±–µ–ª—å –£—Å—Ç–∞">
            <label style="margin-top: 15px; display: block;">–¢–µ–ª–µ—Ñ–æ–Ω (–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è):</label>
            <div style="display: flex; gap: 10px;">
                <input type="tel" id="acc-phone" value="+998901234567">
                <button class="btn" style="width: auto; margin: 0;" onclick="verifyPhone()">–¢–∞—Å–¥–∏“õ–ª–∞—à</button>
            </div>
            <p id="verify-status" style="font-size: 12px; color: var(--gold); margin-top: 10px;">–¢–µ–ª–µ—Ñ–æ–Ω —Ç–∞—Å–¥–∏“õ–ª–∞–Ω–º–∞–≥–∞–Ω. @raspilnaya_bot –æ—Ä“õ–∞–ª–∏ –∫–æ–¥ –æ–ª–∏–Ω–≥.</p>
            <button class="btn-outline" style="margin-top: 40px; padding: 15px; width: 100%; border-radius: 12px; cursor: pointer;" onclick="showScreen('dashboard')">‚¨ÖÔ∏è –û—Ä“õ–∞–≥–∞</button>
        </div>
    </div>

    <div id="scr-help" class="screen">
        <div class="glass-card" style="max-width: 600px; margin: 0 auto; text-align: center;">
            <h2>–Å—Ä–¥–∞–º –ú–∞—Ä–∫–∞–∑–∏</h2>
            <div style="margin: 30px 0;">
                <p>–¢–µ—Ö–Ω–∏–∫ “õ—û–ª–ª–∞–±-“õ—É–≤–≤–∞—Ç–ª–∞—à:</p>
                <a href="https://t.me/shaxzod_mustafayev" style="color: var(--accent); font-size: 20px; text-decoration: none;">@shaxzod_mustafayev</a>
            </div>
            <div style="margin: 30px 0;">
                <p>–¢–µ–ª–µ—Ñ–æ–Ω:</p>
                <a href="tel:+998915329836" style="color: var(--gold); font-size: 20px; text-decoration: none;">+998 91 532 98 36</a>
                <p style="font-weight: 800;">–®–∞—Ö–∑–æ–¥</p>
            </div>
            <button class="btn" onclick="showScreen('dashboard')">–û—Ä“õ–∞–≥–∞</button>
        </div>
    </div>

    <div id="scr-new-order" class="screen">
        <div class="glass-card" style="max-width: 800px; margin: 0 auto;">
            <h2>–ë—É—é—Ä—Ç–º–∞ –ü–∞—Ä–∞–º–µ—Ç—Ä–ª–∞—Ä–∏</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div><label>–ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–æ–º–∏</label><input type="text" id="mat-name" placeholder="–õ–î–°–ü –ò–º–ø–µ—Ä–∏–∞–ª"></div>
                <div><label>–õ–∏—Å—Ç —û–ª—á–∞–º–∏ (L x W)</label><input type="text" id="sheet-size" placeholder="2800x2070"></div>
                <div><label>–ö—Ä–æ–º–∫–∞ “õ–∞–ª–∏–Ω–ª–∏–≥–∏ (–º–º)</label><input type="number" id="edge-thick" value="1"></div>
                <div><label>–ö—Ä–æ–º–∫–∞ –Ω–æ–º–∏</label><input type="text" id="edge-name" placeholder="–ü–í–• 0.45"></div>
            </div>
            <button class="btn" onclick="setupOrderDetails()">–ö–µ–π–∏–Ω–≥–∏ “õ–∞–¥–∞–º ‚Æï</button>
        </div>
    </div>

    <div id="scr-order-details" class="screen">
        <div class="glass-card">
            <h2>–î–µ—Ç–∞–ª–ª–∞—Ä –é–ª—á–∞–º–∏</h2>
            <table class="parts-table" id="parts-input-table">
                <thead>
                    <tr><th>–ù–æ–º–∏</th><th>–£–∑—É–Ω–ª–∏–∫ (L)</th><th>–≠–Ω–∏ (W)</th><th>–°–æ–Ω–∏</th><th>–ö—Ä–æ–º–∫–∞ (L1/L2/W1/W2)</th><th>üîí –ë—É—Ä–∞—à</th><th></th></tr>
                </thead>
                <tbody id="parts-body"></tbody>
            </table>
            <button class="btn-outline" style="width: auto; padding: 10px 20px; border-radius: 8px; cursor: pointer;" onclick="addPartRow()">+ –î–µ—Ç–∞–ª “õ—û—à–∏—à</button>
            <button class="btn" onclick="runOptimization()">–†–∞—Å–∫—Ä–æ–π–Ω–∏ “≤–∏—Å–æ–±–ª–∞—à üöÄ</button>
        </div>
    </div>

    <div id="scr-nesting-result" class="screen">
        <div class="glass-card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ù–∞—Ç–∏–∂–∞—Å–∏</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" style="width: auto; margin: 0; background: #222; color: white; border: 1px solid #444;" onclick="exportPDF()">üìÑ PDF</button>
                    <button class="btn" style="width: auto; margin: 0;" onclick="sendToBot()">üöÄ –ë–æ—Ç–≥–∞ –Æ–±–æ—Ä–∏—à</button>
                </div>
            </div>
            
            <div id="canvas-container"></div>
            
            <div id="result-stats" style="margin-top: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                </div>
            <button class="btn-outline" style="margin-top: 30px; padding: 15px; width: 100%; border-radius: 12px; cursor: pointer;" onclick="showScreen('dashboard')">üè† –ë–æ—à —Å–∞“≥–∏—Ñ–∞–≥–∞ “õ–∞–π—Ç–∏—à</button>
        </div>
    </div>

    <script>
        // GLOBAL STATE
        let currentOrder = {
            mat: '',
            sheetW: 0,
            sheetH: 0,
            edgeName: '',
            edgeThick: 0,
            parts: []
        };

        // NAVIGATION
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('scr-' + id).classList.add('active');
            window.scrollTo(0, 0);
        }

        // AUTH & ACCOUNT
        function verifyPhone() {
            const phone = document.getElementById('acc-phone').value;
            alert(`–ö–æ–¥ @raspilnaya_bot –æ—Ä“õ–∞–ª–∏ ${phone} —Ä–∞“õ–∞–º–∏–≥–∞ —é–±–æ—Ä–∏–ª–¥–∏.`);
            document.getElementById('verify-status').innerText = "‚úÖ –¢–µ–ª–µ—Ñ–æ–Ω —Ç–∞—Å–¥–∏“õ–ª–∞–Ω–¥–∏";
            document.getElementById('verify-status').style.color = "#22c55e";
        }

        // ORDER SETUP
        function setupOrderDetails() {
            currentOrder.mat = document.getElementById('mat-name').value;
            const size = document.getElementById('sheet-size').value.split('x');
            currentOrder.sheetW = parseInt(size[0]);
            currentOrder.sheetH = parseInt(size[1]);
            currentOrder.edgeName = document.getElementById('edge-name').value;
            currentOrder.edgeThick = parseInt(document.getElementById('edge-thick').value);
            
            if(!currentOrder.sheetW || !currentOrder.sheetH) return alert("–õ–∏—Å—Ç —û–ª—á–∞–º–∏–Ω–∏ —Ç—û“ì—Ä–∏ –∫–∏—Ä–∏—Ç–∏–Ω–≥!");
            
            addPartRow();
            showScreen('order-details');
        }

        function addPartRow() {
            const tbody = document.getElementById('parts-body');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="p-name" value="–î–µ—Ç–∞–ª ${tbody.children.length + 1}"></td>
                <td><input type="number" class="p-l" value="600"></td>
                <td><input type="number" class="p-w" value="400"></td>
                <td><input type="number" class="p-q" value="1"></td>
                <td>
                    <div style="display:flex; gap:3px;">
                        <input type="checkbox" class="p-e1" title="L1"> <input type="checkbox" class="p-e2" title="L2"> | 
                        <input type="checkbox" class="p-e3" title="W1"> <input type="checkbox" class="p-e4" title="W2">
                    </div>
                </td>
                <td style="text-align:center;"><input type="checkbox" class="p-lock"></td>
                <td onclick="this.parentElement.remove()" style="cursor:pointer; color:red;">‚úï</td>
            `;
            tbody.appendChild(tr);
        }

        // NESTING ENGINE (MaxRects Style Simulation)
        function runOptimization() {
            currentOrder.parts = [];
            document.querySelectorAll('#parts-body tr').forEach(tr => {
                const q = parseInt(tr.querySelector('.p-q').value);
                for(let i=0; i<q; i++) {
                    currentOrder.parts.push({
                        name: tr.querySelector('.p-name').value,
                        l: parseInt(tr.querySelector('.p-l').value),
                        w: parseInt(tr.querySelector('.p-w').value),
                        edges: [
                            tr.querySelector('.p-e1').checked, tr.querySelector('.p-e2').checked,
                            tr.querySelector('.p-e3').checked, tr.querySelector('.p-e4').checked
                        ],
                        lock: tr.querySelector('.p-lock').checked
                    });
                }
            });

            visualizeNesting();
            showScreen('nesting-result');
        }

        function visualizeNesting() {
            const container = document.getElementById('canvas-container');
            container.innerHTML = "";
            
            const kerf = 4; // –ê—Ä—Ä–∞ “õ–∞–ª–∏–Ω–ª–∏–≥–∏
            let partsToPlace = [...currentOrder.parts].sort((a,b) => (b.l * b.w) - (a.l * a.w));
            let sheetIdx = 0;

            while(partsToPlace.length > 0) {
                sheetIdx++;
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const scale = 0.25; 
                canvas.width = currentOrder.sheetW * scale;
                canvas.height = currentOrder.sheetH * scale;
                
                ctx.fillStyle = "white"; ctx.fillRect(0,0, canvas.width, canvas.height);
                
                let cx = 5, cy = 5, rh = 0;
                let nextRound = [];

                partsToPlace.forEach(p => {
                    let w = p.l, h = p.w;
                    
                    // –ü–æ–≤–æ—Ä–æ—Ç —Ç–µ–∫—à–∏—Ä–∏—à
                    if(!p.lock && (cx + h <= currentOrder.sheetW - 5) && (cy + w <= currentOrder.sheetH - 5) && h > w) {
                        [w, h] = [h, w];
                    }

                    if(cx + w > currentOrder.sheetW - 5) { cx = 5; cy += rh + kerf; rh = 0; }
                    
                    if(cy + h > currentOrder.sheetH - 5) {
                        nextRound.push(p);
                        return;
                    }

                    // Draw Part
                    ctx.fillStyle = "#f0f2f5";
                    ctx.fillRect(cx*scale, cy*scale, w*scale, h*scale);
                    ctx.strokeStyle = "#444"; ctx.lineWidth = 0.5;
                    ctx.strokeRect(cx*scale, cy*scale, w*scale, h*scale);

                    // Draw Edges (Yellow line)
                    ctx.strokeStyle = "gold"; ctx.lineWidth = 2;
                    if(p.edges[0]) { ctx.beginPath(); ctx.moveTo(cx*scale, cy*scale); ctx.lineTo((cx+w)*scale, cy*scale); ctx.stroke(); }
                    if(p.edges[1]) { ctx.beginPath(); ctx.moveTo(cx*scale, (cy+h)*scale); ctx.lineTo((cx+w)*scale, (cy+h)*scale); ctx.stroke(); }
                    
                    // Labels
                    ctx.fillStyle = "black"; ctx.font = "8px Arial";
                    if(w > 100) ctx.fillText(`${p.name}`, (cx+5)*scale, (cy+15)*scale);
                    if(w > 100) ctx.fillText(`${p.l}x${p.w}`, (cx+5)*scale, (cy+30)*scale);

                    cx += w + kerf;
                    rh = Math.max(rh, h);
                });

                container.appendChild(canvas);
                partsToPlace = nextRound;
            }

            document.getElementById('result-stats').innerHTML = `
                <div class="glass-card" style="padding:15px; text-align:center;">–õ–∏—Å—Ç —Å–æ–Ω–∏: ${sheetIdx}</div>
                <div class="glass-card" style="padding:15px; text-align:center;">–ú–∞—Ç–µ—Ä–∏–∞–ª: ${currentOrder.mat}</div>
                <div class="glass-card" style="padding:15px; text-align:center;">–ö—Ä–æ–º–∫–∞: ${currentOrder.edgeName}</div>
            `;
        }

        // EXPORT & SOCIAL
        async function exportPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('l', 'mm', 'a4');
            const canvas = await html2canvas(document.getElementById('canvas-container'));
            const imgData = canvas.toDataURL('image/png');
            pdf.text(`Order: ${currentOrder.mat} | Mustafayev Academy`, 10, 10);
            pdf.addImage(imgData, 'PNG', 10, 20, 280, 150);
            pdf.save("raskroy_tabriz.pdf");
        }

        async function sendToBot() {
            alert("–ú–∞—ä–ª—É–º–æ—Ç–ª–∞—Ä @raspilnaya_bot –≥–∞ —é–±–æ—Ä–∏–ª–¥–∏. –ë—É—é—Ä—Ç–º–∞ ‚Ññ" + Math.floor(Math.random()*9000));
            showScreen('dashboard');
        }

    </script>
</body>
</html>
