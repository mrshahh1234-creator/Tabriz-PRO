<!DOCTYPE html>
<html lang="uz">
<head><meta charset="UTF-8"><link rel="stylesheet" href="style.css"><title>Nesting Result</title></head>
<body>
    <div class="sidebar"><div class="brand">TABRIZ</div><a href="dashboard.html" class="nav-item">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a><a href="order.html" class="nav-item active">üìê –Ø–Ω–≥–∏ –†–∞—Å–∫—Ä–æ–π</a></div>
    <div class="main">
        <div id="plots"></div>
        <div class="glass-card" style="margin-top: 40px; border-left: 4px solid var(--gold);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="color: #71717A; font-size: 14px;">–ñ–∞–º–∏ —Ö–∞—Ä–∞–∂–∞—Ç</div>
                    <div style="font-size: 32px; font-weight: 700; color: var(--gold);" id="totalPrice">0 UZS</div>
                </div>
                <button class="btn" style="width: auto; padding: 15px 50px;" onclick="send()">–ë–£–Æ–†–¢–ú–ê–ù–ò –¢–ê–°–î–ò“ö–õ–ê–®</button>
            </div>
        </div>
    </div>
    <div class="academy-watermark">MUSTAFAYEV ACADEMY</div>
    <script>
        const parts = JSON.parse(localStorage.getItem('temp_parts'));
        const [mW, mH] = localStorage.getItem('temp_mat').split('x').map(Number);
        const container = document.getElementById('plots');
        
        let sheetIdx = 0;
        let pCopy = [...parts].sort((a,b) => (b.l*b.w)-(a.l*a.w));

        while(pCopy.length > 0) {
            sheetIdx++;
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = mW * 0.25; canvas.height = mH * 0.25;
            container.appendChild(canvas);
            
            ctx.fillStyle = "#fff"; ctx.fillRect(0,0,canvas.width,canvas.height);
            let cx=10, cy=10, rh=0, rem=[];
            pCopy.forEach(p => {
                if(cx + p.l > mW - 10) { cx=10; cy+=rh+5; rh=0; }
                if(cy + p.w > mH - 10) { rem.push(p); return; }
                ctx.strokeStyle = "#000"; ctx.strokeRect(cx*0.25, cy*0.25, p.l*0.25, p.w*0.25);
                cx += p.l + 4; rh = Math.max(rh, p.w);
            });
            pCopy = rem;
        }

        const final = (sheetIdx * 500000).toLocaleString();
        document.getElementById('totalPrice').innerText = final + " UZS";

        async function send() {
            const msg = `üì¶ –¢–ê–ë–†–ò–ó B2B\nüë§ –ú–∏–∂–æ–∑: ${localStorage.getItem('user')}\nüî¢ –õ–∏—Å—Ç: ${sheetIdx} —Ç–∞\nüí∞ –°—É–º–º–∞: ${final} —Å—û–º`;
            await fetch(`https://api.telegram.org/bot7927717291:AAG4h_LbZoY-1s2y0_zzNoCFudrU7pPDNas/sendMessage?chat_id=1015769230&text=${encodeURIComponent(msg)}`);
            alert("–ë—É—é—Ä—Ç–º–∞ “õ–∞–±—É–ª “õ–∏–ª–∏–Ω–¥–∏!"); window.location.href='dashboard.html';
        }
    </script>
</body>
</html>
